<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Learning Chatbot</title>
    <style>
        :root {
            --primary: #4361ee;
            --danger: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --info: #4895ef;
            --background: #f8f9fa;
            --text: #212529;
            --bot-color: #f1f1f1;
            --user-color: #e3f2fd;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            
            /* Dark mode variables */
            --dark-bg: #121212;
            --dark-text: #e0e0e0;
            --dark-bot-color: #1e1e1e;
            --dark-user-color: #2d3748;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            position: relative;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            --background: var(--dark-bg);
            --text: var(--dark-text);
            --bot-color: var(--dark-bot-color);
            --user-color: var(--dark-user-color);
        }

        /* [Previous CSS styles remain the same...] */

        .settings-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .settings-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .settings-panel {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--shadow);
            width: 250px;
            display: none;
            z-index: 101;
        }

        .dark-mode .settings-panel {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        .settings-panel h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .dark-mode .settings-panel h3 {
            border-color: #333;
        }

        .settings-option {
            margin: 10px 0;
        }

        select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: white;
            color: var(--text);
        }

        .dark-mode select {
            background: #333;
            border-color: #555;
            color: white;
        }

        /* [Rest of your existing CSS...] */
    </style>
</head>
<body>
    <div class="settings-menu">
        <button class="settings-btn">⚙️</button>
        <div class="settings-panel">
            <h3>Settings</h3>
            <div class="settings-option">
                <label>Bot Name:</label>
                <input type="text" id="botNameInput" placeholder="Assistant">
            </div>
            <div class="settings-option">
                <label>Voice:</label>
                <select id="voiceSelect"></select>
            </div>
            <div class="settings-option">
                <label>Dark Mode:</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- [Previous HTML structure remains the same...] -->

    <script>
        // ======================
        // NEW SETTINGS SYSTEM
        // ======================
        let botName = localStorage.getItem('botName') || "Assistant";
        let selectedVoice = null;

        function initSettings() {
            // Toggle settings panel
            document.querySelector('.settings-btn').addEventListener('click', function() {
                const panel = document.querySelector('.settings-panel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            });

            // Bot name setting
            const botNameInput = document.getElementById('botNameInput');
            botNameInput.value = botName;
            botNameInput.addEventListener('change', function() {
                botName = this.value || "Assistant";
                localStorage.setItem('botName', botName);
            });

            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.checked = localStorage.getItem('darkMode') === 'true';
            updateDarkMode();
            
            darkModeToggle.addEventListener('change', function() {
                localStorage.setItem('darkMode', this.checked);
                updateDarkMode();
            });

            // Voice selection
            populateVoiceList();
            document.getElementById('voiceSelect').addEventListener('change', function() {
                const voiceName = this.value;
                const voices = synth.getVoices();
                selectedVoice = voices.find(v => v.name === voiceName);
            });
        }

        function updateDarkMode() {
            document.body.classList.toggle('dark-mode', localStorage.getItem('darkMode') === 'true');
        }

        function populateVoiceList() {
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '';
            
            // Default option
            const defaultOption = document.createElement('option');
            defaultOption.textContent = 'Select a voice';
            defaultOption.value = '';
            voiceSelect.appendChild(defaultOption);

            // Try to find British voices first
            const voices = synth.getVoices();
            const britishVoices = voices.filter(v => v.lang.includes('en-GB'));
            const otherEnglishVoices = voices.filter(v => v.lang.includes('en-') && !v.lang.includes('en-GB'));
            
            // Add British voices first
            if (britishVoices.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'British Voices';
                britishVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.name;
                    optgroup.appendChild(option);
                });
                voiceSelect.appendChild(optgroup);
            }
            
            // Add other English voices
            if (otherEnglishVoices.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Other English Voices';
                otherEnglishVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.name;
                    optgroup.appendChild(option);
                });
                voiceSelect.appendChild(optgroup);
            }

            // Try to select a British male voice by default
            const preferredVoices = [
                'Google UK English Male',
                'Microsoft George - English (United Kingdom)',
                'Daniel'
            ];
            
            for (const voiceName of preferredVoices) {
                const voice = voices.find(v => v.name === voiceName);
                if (voice) {
                    voiceSelect.value = voiceName;
                    selectedVoice = voice;
                    break;
                }
            }
        }

        // ======================
        // UPDATED VOICE FUNCTIONS
        // ======================
        function speak(text) {
            const now = Date.now();
            if (now - lastSpeechTime < speechDelay) return;
            lastSpeechTime = now;
            
            if (synth.speaking) synth.cancel();
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.voice = selectedVoice || getPreferredVoice();
            currentUtterance.pitch = 1;
            currentUtterance.rate = 1;
            
            synth.speak(currentUtterance);
            updateTtsControls();
        }

        // ======================
        // UPDATED MESSAGE DISPLAY
        // ======================
        function addMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            
            if (sender === 'user') {
                messageElement.textContent = message;
            } else if (sender === 'system') {
                messageElement.textContent = `System: ${message}`;
                messageElement.classList.add('system-message');
            } else if (sender === 'bot') {
                messageElement.textContent = `${botName}: ${message}`;
            }
            
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if (sender === 'bot') {
                lastBotResponse = message;
            }
            
            if (sender !== 'system') {
                saveToHistory(sender, message);
            }
        }

        // ======================
        // INITIALIZATION
        // ======================
        function init() {
            initSettings();
            
            // Load voices when they become available
            synth.onvoiceschanged = function() {
                populateVoiceList();
            };

            // [Rest of your existing initialization...]
            
            // Update welcome message to use bot name
            setTimeout(() => {
                addMessage("bot", `Hello! I'm ${botName}, your personal assistant.`);
                addMessage("bot", "You can teach me things by saying 'Remember [fact]'");
                addMessage("bot", "Change my name or voice in the settings ⚙️");
            }, 500);
        }

        // [Rest of your existing JavaScript...]
    </script>
</body>
</html>
