<!DOCTYPE html>
<html>
<head>
    <title>Enhanced Chatbot</title>
    <style>
        /* [Previous CSS remains exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains exactly the same] -->

    <script>
        // Chatbot application - IMPROVED VERSION
        const commands = [];
        let currentUtterance = null;
        let isPaused = false;
        const speechSynthesis = window.speechSynthesis;
        const CHUNK_SIZE = 30000;
        
        // Initialize UI - FIXED SYNTAX ERROR
        document.addEventListener('DOMContentLoaded', function() {
            // [Previous event listeners remain the same]
        });
        
        function addDefaultCommands() {
            commands.push({
                type: "speech",
                triggers: ["hello", "hi", "hey"],
                response: "Hello there! How can I help you today?"
            });
            
            commands.push({
                type: "function",
                triggers: ["time", "what time is it"],
                action: function() {
                    const now = new Date();
                    addMessage("bot", `The current time is ${now.toLocaleTimeString()}`);
                }
            });
        }
        
        // FIXED SYNTAX ERROR IN THIS FUNCTION
        function findMatchingCommand(message) {
            return commands.find(cmd => 
                cmd.triggers.some(trigger => 
                    message.toLowerCase().includes(trigger.toLowerCase())
                ));
        }

        // ENHANCED FUNCTION COMMAND EDITOR
        function openModal(type) {
            modalBody.innerHTML = "";
            
            if (type === "speech") {
                modalBody.innerHTML = `
                    <h2>Add Speech Command</h2>
                    <div>
                        <label>Trigger Phrases (comma separated):</label>
                        <input type="text" id="triggers" placeholder="hello,hi,hey">
                    </div>
                    <div>
                        <label>Response Text:</label>
                        <textarea id="response" placeholder="Enter response text here..."></textarea>
                    </div>
                    <button onclick="addNewCommand('speech')">Add Command</button>
                `;
            } else {
                modalBody.innerHTML = `
                    <h2>Add Function Command</h2>
                    <div>
                        <label>Trigger Phrases (comma separated):</label>
                        <input type="text" id="funcTriggers" placeholder="time,what time is it">
                    </div>
                    <div>
                        <label>Function Name:</label>
                        <input type="text" id="funcName" placeholder="showTime">
                    </div>
                    <div>
                        <label>Function Code:</label>
                        <textarea id="funcCode" placeholder="// Available variables:
// addMessage(sender, message)
// chatBox (DOM element)
                        
function execute() {
    // Your code here
    const now = new Date();
    addMessage('bot', 'Current time: ' + now.toLocaleTimeString());
}"></textarea>
                    </div>
                    <button onclick="addNewCommand('function')">Add Command</button>
                `;
            }
            
            modal.style.display = "block";
        }

        // IMPROVED FUNCTION COMMAND HANDLING
        function addNewCommand(type) {
            try {
                if (type === "speech") {
                    const triggers = document.getElementById("triggers").value.split(',').map(t => t.trim());
                    const response = document.getElementById("response").value;
                    
                    if (!triggers.length || !response) {
                        alert("Please fill in all fields");
                        return;
                    }
                    
                    commands.push({
                        type: "speech",
                        triggers: triggers,
                        response: response,
                        category: "general" // Added simple categorization
                    });
                } else {
                    const triggers = document.getElementById("funcTriggers").value.split(',').map(t => t.trim());
                    const funcName = document.getElementById("funcName").value.trim();
                    const funcCode = document.getElementById("funcCode").value;
                    
                    if (!triggers.length || !funcName || !funcCode) {
                        alert("Please fill in all fields");
                        return;
                    }
                    
                    // Safer function creation
                    const funcWrapper = new Function(`
                        ${funcCode}
                        return { execute: execute };
                    `)();
                    
                    if (!funcWrapper.execute) {
                        throw new Error("Function must contain an execute() method");
                    }
                    
                    commands.push({
                        type: "function",
                        triggers: triggers,
                        action: funcWrapper.execute,
                        category: "general",
                        name: funcName
                    });
                }
                
                modal.style.display = "none";
                alert("Command added successfully!");
            } catch (e) {
                alert(`Error: ${e.message}`);
                console.error(e);
            }
        }

        // ENHANCED COMMAND DISPLAY
        function showCommands() {
            modalBody.innerHTML = `
                <h2>Current Commands (${commands.length})</h2>
                <input type="text" id="commandFilter" placeholder="Filter commands..." style="width:100%;margin-bottom:10px;">
                <div id="commandList">
                    ${commands.map((cmd, i) => `
                        <div class="command-item">
                            <h3>${cmd.name || cmd.type.toUpperCase()} Command</h3>
                            <p><strong>Type:</strong> ${cmd.type} | <strong>Category:</strong> ${cmd.category || 'none'}</p>
                            <p><strong>Triggers:</strong> ${cmd.triggers.join(', ')}</p>
                            ${cmd.type === 'speech' ? 
                                `<p><strong>Response:</strong> ${cmd.response.length > 100 ? 
                                    cmd.response.substring(0, 100) + '...' : 
                                    cmd.response}</p>` : 
                                ''}
                            <button onclick="deleteCommand(${i})">Delete</button>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Add filtering functionality
            document.getElementById("commandFilter").addEventListener("input", function() {
                const filter = this.value.toLowerCase();
                const items = document.querySelectorAll(".command-item");
                
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(filter) ? "block" : "none";
                });
            });
            
            modal.style.display = "block";
        }

        // [Rest of your existing functions remain the same]
        
        // Make functions available globally
        window.addNewCommand = addNewCommand;
        window.deleteCommand = deleteCommand;
    </script>
</body>
</html>
