<!DOCTYPE html>
<html>
<head>
    <title>Controlled-Speech Chatbot</title>
    <style>
        /* Previous styles remain the same */
        .settings-panel {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #34a853;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <!-- Previous HTML remains the same until voice-controls -->
    
    <div class="voice-controls">
        <button class="voice-btn" id="speakBtn" onclick="speakLastResponse()">üîä</button>
        <button class="voice-btn" id="stopSpeakBtn" onclick="stopSpeaking()">‚èπÔ∏è</button>
        <label class="toggle-switch">
            <input type="checkbox" id="speechToggle" checked>
            <span class="slider"></span>
        </label>
        <span>Voice Responses</span>
    </div>
    
    <!-- Add this new panel -->
    <div class="settings-panel">
        <h3>Speech Settings</h3>
        <p><label>
            <input type="checkbox" id="onlySpeakForCommands" checked>
            Only speak for direct commands
        </label></p>
        <p><label>
            <input type="checkbox" id="dontSpeakAutomatically">
            Don't speak unless I click the üîä button
        </label></p>
    </div>

    <script>
        // Add these variables at the top
        let lastSpeechTime = 0;
        const speechDelay = 3000; // 3 seconds between speeches
        
        // Modify the speak function
        function speak(text) {
            // Check if speech is disabled
            if (!document.getElementById('speechToggle').checked) {
                return;
            }
            
            // Check if user wants manual control only
            if (document.getElementById('dontSpeakAutomatically').checked) {
                return;
            }
            
            // Check if we should only speak for commands
            if (document.getElementById('onlySpeakForCommands').checked && 
                !lastBotResponse.includes("Executing command:")) {
                return;
            }
            
            // Throttle speech frequency
            const now = Date.now();
            if (now - lastSpeechTime < speechDelay) {
                return;
            }
            lastSpeechTime = now;
            
            // Rest of the speak function remains the same
            if (synth.speaking) synth.cancel();
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.voice = getPreferredVoice();
            currentUtterance.pitch = 1;
            currentUtterance.rate = 1;
            
            speakBtn.disabled = true;
            stopSpeakBtn.disabled = false;
            
            currentUtterance.onend = () => {
                speakBtn.disabled = false;
                stopSpeakBtn.disabled = true;
            };
            
            synth.speak(currentUtterance);
        }

        // Modify the respondToQuery function
        function respondToQuery(response, isCommand = false) {
            lastBotResponse = response;
            displayMessage(response, 'bot');
            
            // Only speak if it's a command or settings allow it
            if (isCommand || 
                (!document.getElementById('onlySpeakForCommands').checked &&
                 !document.getElementById('dontSpeakAutomatically').checked)) {
                speak(response);
            }
        }

        // Update command executions to mark them as commands
        function checkForCustomCommand(message) {
            const lowerMsg = message.toLowerCase();
            
            for (const command of customCommands) {
                for (const trigger of command.triggers) {
                    if (lowerMsg.includes(trigger.toLowerCase())) {
                        displayMessage(`Executing command: "${trigger}"`, 'command');
                        try {
                            if (typeof command.action === 'string' && command.action.endsWith(')')) {
                                eval(command.action);
                            } else if (typeof command.action === 'function') {
                                command.action();
                            }
                        } catch (e) {
                            console.error("Error executing command:", e);
                            respondToQuery("Sorry, I had trouble executing that command.", true);
                        }
                        return true;
                    }
                }
            }
            return false;
        }
    </script>
</body>
</html>
