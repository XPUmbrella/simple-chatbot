<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Learning Chatbot</title>
    <style>
        :root {
            --primary: #4361ee;
            --danger: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --info: #4895ef;
            --background: #f8f9fa;
            --text: #212529;
            --bot-color: #f1f1f1;
            --user-color: #e3f2fd;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            
            /* Dark mode variables */
            --dark-bg: #121212;
            --dark-text: #e0e0e0;
            --dark-bot-color: #1e1e1e;
            --dark-user-color: #2d3748;
            --dark-border: #333;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            position: relative;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            --background: var(--dark-bg);
            --text: var(--dark-text);
            --bot-color: var(--dark-bot-color);
            --user-color: var(--dark-user-color);
        }

        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .clock-container {
            text-align: center;
            margin: 20px 0;
        }

        .digital-clock {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .digital-clock:hover {
            transform: scale(1.05);
        }

        .fullscreen-clock {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 4rem;
            cursor: pointer;
        }

        .fullscreen-clock .date {
            font-size: 2rem;
            margin-top: 20px;
        }

        .chat-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .dark-mode .chat-container {
            background-color: var(--dark-bot-color);
        }

        .chat-header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .chat-box {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: var(--background);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            padding: 12px 16px;
            border-radius: 18px;
            margin: 12px 0;
            max-width: 85%;
            word-wrap: break-word;
            box-shadow: var(--shadow);
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
            opacity: 0.95;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 0.95; transform: translateY(0); }
        }

        .user-message {
            background: var(--user-color);
            color: var(--text);
            margin-left: auto;
            border-radius: 18px 18px 0 18px;
        }

        .dark-mode .user-message {
            background: var(--dark-user-color);
            color: white;
        }

        .bot-message {
            background: var(--bot-color);
            border-radius: 18px 18px 18px 0;
        }

        .system-message {
            background: #f8f9fa;
            margin: 12px auto;
            max-width: 90%;
            text-align: center;
            font-style: italic;
            color: #6c757d;
            border-left: 4px solid var(--info);
            font-size: 0.9em;
        }

        .dark-mode .system-message {
            background: #1e1e1e;
            color: #aaa;
            border-left-color: var(--primary);
        }

        .input-area {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid #eee;
            gap: 12px;
        }

        .dark-mode .input-area {
            background-color: var(--dark-bot-color);
            border-top-color: var(--dark-border);
        }

        #userInput {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid #ced4da;
            border-radius: 24px;
            font-size: 16px;
            background: white;
            color: var(--text);
            transition: all 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .dark-mode #userInput {
            background: #333;
            border-color: #555;
            color: white;
        }

        #userInput:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        button {
            padding: 14px 22px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            font-weight: 500;
            box-shadow: var(--shadow);
        }

        button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        #sendButton {
            margin-left: 0;
        }

        #micButton {
            background: var(--danger);
            width: 56px;
            height: 56px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border-radius: 50%;
        }

        #micButton.listening {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(247, 37, 133, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(247, 37, 133, 0); }
        }

        .control-panel {
            background: white;
            border-radius: 14px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .dark-mode .control-panel {
            background: var(--dark-bot-color);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .panel-header {
            border-bottom-color: var(--dark-border);
        }

        .panel-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1em;
        }

        .memory-actions {
            display: flex;
            gap: 10px;
            padding: 0 15px 15px;
            flex-wrap: wrap;
        }

        .memory-actions button {
            flex: 1;
            min-width: 120px;
        }

        #fileInput {
            display: none;
        }

        .tts-controls {
            display: flex;
            gap: 10px;
            padding: 15px;
            flex-wrap: wrap;
        }

        #readBtn {
            background-color: var(--success);
            color: white;
        }

        #pauseBtn {
            background-color: var(--warning);
            color: white;
        }

        #resumeBtn {
            background-color: var(--info);
            color: white;
        }

        #stopBtn {
            background-color: var(--danger);
            color: white;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            background-color: var(--bot-color);
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 5px;
        }

        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #666;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        #status {
            height: 20px;
            margin-top: 8px;
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            font-style: italic;
        }

        .dark-mode #status {
            color: #aaa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
        }

        .dark-mode .modal-content {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .command-item {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid var(--primary);
        }

        .dark-mode .command-item {
            background-color: #1e1e1e;
        }

        .settings-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .settings-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .settings-panel {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--shadow);
            width: 250px;
            display: none;
            z-index: 101;
        }

        .dark-mode .settings-panel {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        .settings-panel h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .dark-mode .settings-panel h3 {
            border-color: var(--dark-border);
        }

        .settings-option {
            margin: 10px 0;
        }

        .settings-option label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        select, input[type="text"], input[type="range"] {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: white;
            color: var(--text);
        }

        .dark-mode select,
        .dark-mode input[type="text"],
        .dark-mode input[type="range"] {
            background: #333;
            border-color: #555;
            color: white;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-value {
            min-width: 30px;
            text-align: center;
        }

        .features-panel {
            background: white;
            border-radius: 14px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .dark-mode .features-panel {
            background: var(--dark-bot-color);
        }

        .feature-buttons {
            display: flex;
            gap: 10px;
            padding: 15px;
            flex-wrap: wrap;
        }

        .feature-buttons button {
            flex: 1;
            min-width: 120px;
        }

        #jokeBtn {
            background-color: #7209b7;
            color: white;
        }

        #quoteBtn {
            background-color: #3a86ff;
            color: white;
        }

        #factBtn {
            background-color: #f8961e;
            color: white;
        }

        #poemBtn {
            background-color: #8338ec;
            color: white;
        }

        #riddleBtn {
            background-color: #ff006e;
            color: white;
        }

        #storyBtn {
            background-color: #3a86ff;
            color: white;
        }

        @media (max-width: 600px) {
            .chat-container {
                height: 70vh;
            }
            .message {
                max-width: 90%;
            }
            .memory-actions button,
            .feature-buttons button {
                min-width: 100%;
            }
            .settings-panel {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="settings-menu">
        <button class="settings-btn">‚öôÔ∏è</button>
        <div class="settings-panel">
            <h3>Settings</h3>
            <div class="settings-option">
                <label for="botNameInput">Bot Name:</label>
                <input type="text" id="botNameInput" placeholder="Assistant">
            </div>
            <div class="settings-option">
                <label for="voiceSelect">Voice:</label>
                <select id="voiceSelect"></select>
            </div>
            <div class="settings-option">
                <label for="voiceRate">Voice Speed:</label>
                <div class="range-container">
                    <input type="range" id="voiceRate" min="0.5" max="2" step="0.1" value="1">
                    <span class="range-value" id="rateValue">1</span>
                </div>
            </div>
            <div class="settings-option">
                <label for="voicePitch">Voice Pitch:</label>
                <div class="range-container">
                    <input type="range" id="voicePitch" min="0.5" max="2" step="0.1" value="1">
                    <span class="range-value" id="pitchValue">1</span>
                </div>
            </div>
            <div class="settings-option">
                <label>Dark Mode:</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="clock-container">
        <div class="digital-clock" id="digitalClock"></div>
    </div>

    <div class="fullscreen-clock" id="fullscreenClock" style="display: none;">
        <div class="time" id="fsTime"></div>
        <div class="date" id="fsDate"></div>
    </div>

    <h1>Ultimate Learning Chatbot</h1>
    
    <div class="chat-container">
        <div class="chat-header">
            ChatBot Assistant
        </div>
        <div class="chat-box" id="chatBox">
            <!-- Messages will appear here -->
        </div>
        
        <div class="typing-indicator" id="typing-indicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Type your message or say 'Remember my name is Alex'..." autocomplete="off" autofocus>
            <button id="sendButton">Send</button>
            <button id="micButton" title="Toggle microphone">üé§</button>
        </div>
    </div>
    
    <div id="status"></div>
    
    <div class="control-panel">
        <div class="panel-header">
            <div class="panel-title">Memory Controls</div>
        </div>
        <div class="memory-actions">
            <button id="showMemoryBtn">Show Memories</button>
            <button id="downloadMemoryBtn">Download Memories</button>
            <button id="uploadMemoryBtn">Upload Memories</button>
            <button id="clearMemoryBtn">Clear Memories</button>
        </div>
        <input type="file" id="fileInput" accept=".txt,.json">
    </div>

    <div class="control-panel">
        <div class="panel-header">
            <div class="panel-title">Voice Controls</div>
        </div>
        <div class="tts-controls">
            <button id="readBtn">üîä Read Last</button>
            <button id="pauseBtn" disabled>‚è∏ Pause</button>
            <button id="resumeBtn" disabled>‚ñ∂ Resume</button>
            <button id="stopBtn" disabled>‚èπ Stop</button>
        </div>
    </div>

    <div class="features-panel">
        <div class="panel-header">
            <div class="panel-title">Fun Features</div>
        </div>
        <div class="feature-buttons">
            <button id="jokeBtn">üòÜ Tell a Joke</button>
            <button id="quoteBtn">üí¨ Random Quote</button>
            <button id="factBtn">üß† Interesting Fact</button>
            <button id="poemBtn">‚úçÔ∏è Write a Poem</button>
            <button id="riddleBtn">ü§î Riddle Me</button>
            <button id="storyBtn">üìñ Short Story</button>
        </div>
    </div>
    
    <div id="memoryModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Chatbot Memories</h2>
            <div id="memoryList"></div>
        </div>
    </div>

    <script>
        // ======================
        // CORE SETUP
        // ======================
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        const synth = window.speechSynthesis;
        let currentUtterance = null;
        let isListening = false;
        let lastBotResponse = "";
        let lastSpeechTime = 0;
        const speechDelay = 2000; // 2 seconds between speeches

        // DOM elements
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const micButton = document.getElementById('micButton');
        const statusElement = document.getElementById('status');
        const typingIndicator = document.getElementById('typing-indicator');
        const memoryModal = document.getElementById('memoryModal');
        const memoryList = document.getElementById('memoryList');
        const fileInput = document.getElementById('fileInput');

        // Initialize memory systems
        if (!localStorage.getItem('chatbotMemory')) {
            localStorage.setItem('chatbotMemory', JSON.stringify({}));
        }
        if (!localStorage.getItem('chatHistory')) {
            localStorage.setItem('chatHistory', JSON.stringify([]));
        }

        // Conversation context
        let conversationContext = {
            lastTopic: null,
            lastEntities: {}
        };

        // Voice settings
        let voiceRate = parseFloat(localStorage.getItem('voiceRate')) || 1;
        let voicePitch = parseFloat(localStorage.getItem('voicePitch')) || 1;

        // ======================
        // SETTINGS SYSTEM
        // ======================
        let botName = localStorage.getItem('botName') || "Assistant";
        let selectedVoice = null;

        function initSettings() {
            // Toggle settings panel
            document.querySelector('.settings-btn').addEventListener('click', function() {
                const panel = document.querySelector('.settings-panel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            });

            // Bot name setting
            const botNameInput = document.getElementById('botNameInput');
            botNameInput.value = botName;
            botNameInput.addEventListener('change', function() {
                botName = this.value || "Assistant";
                localStorage.setItem('botName', botName);
                updateChatHeader();
            });

            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.checked = localStorage.getItem('darkMode') === 'true';
            updateDarkMode();
            
            darkModeToggle.addEventListener('change', function() {
                localStorage.setItem('darkMode', this.checked);
                updateDarkMode();
            });

            // Voice selection
            populateVoiceList();
            document.getElementById('voiceSelect').addEventListener('change', function() {
                const voiceName = this.value;
                const voices = synth.getVoices();
                selectedVoice = voices.find(v => v.name === voiceName);
                localStorage.setItem('selectedVoice', voiceName);
            });

            // Voice rate control
            const voiceRateInput = document.getElementById('voiceRate');
            voiceRateInput.value = voiceRate;
            document.getElementById('rateValue').textContent = voiceRate;
            voiceRateInput.addEventListener('input', function() {
                voiceRate = parseFloat(this.value);
                document.getElementById('rateValue').textContent = voiceRate;
                localStorage.setItem('voiceRate', voiceRate);
            });

            // Voice pitch control
            const voicePitchInput = document.getElementById('voicePitch');
            voicePitchInput.value = voicePitch;
            document.getElementById('pitchValue').textContent = voicePitch;
            voicePitchInput.addEventListener('input', function() {
                voicePitch = parseFloat(this.value);
                document.getElementById('pitchValue').textContent = voicePitch;
                localStorage.setItem('voicePitch', voicePitch);
            });

            // Load saved voice if exists
            const savedVoice = localStorage.getItem('selectedVoice');
            if (savedVoice) {
                setTimeout(() => {
                    const voiceSelect = document.getElementById('voiceSelect');
                    voiceSelect.value = savedVoice;
                    const voices = synth.getVoices();
                    selectedVoice = voices.find(v => v.name === savedVoice);
                }, 500);
            }
        }

        function updateDarkMode() {
            const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
            document.body.classList.toggle('dark-mode', darkModeEnabled);
        }

        function updateChatHeader() {
            document.querySelector('.chat-header').textContent = `${botName}`;
        }

        function populateVoiceList() {
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '';
            
            // Default option
            const defaultOption = document.createElement('option');
            defaultOption.textContent = 'Select a voice';
            defaultOption.value = '';
            voiceSelect.appendChild(defaultOption);

            // Get all available voices
            const voices = synth.getVoices();
            
            // Try to find British voices first
            const britishVoices = voices.filter(v => v.lang.includes('en-GB'));
            const otherEnglishVoices = voices.filter(v => v.lang.includes('en-') && !v.lang.includes('en-GB'));
            
            // Add British voices first
            if (britishVoices.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'British Voices';
                britishVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.name;
                    optgroup.appendChild(option);
                    
                    // Prefer British male voices
                    if (voice.name.includes('Male') || voice.name.includes('George')) {
                        option.selected = true;
                        selectedVoice = voice;
                    }
                });
                voiceSelect.appendChild(optgroup);
            }
            
            // Add other English voices
            if (otherEnglishVoices.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Other English Voices';
                otherEnglishVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.name;
                    optgroup.appendChild(option);
                });
                voiceSelect.appendChild(optgroup);
            }
        }

        // ======================
        // DIGITAL CLOCK FUNCTIONS
        // ======================
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Update regular clock
            document.getElementById('digitalClock').textContent = `${timeStr} | ${dateStr}`;

            // Update fullscreen clock if visible
            if (document.getElementById('fullscreenClock').style.display === 'flex') {
                document.getElementById('fsTime').textContent = timeStr;
                document.getElementById('fsDate').textContent = dateStr;
            }
        }

        function toggleFullscreenClock() {
            const fsClock = document.getElementById('fullscreenClock');
            fsClock.style.display = fsClock.style.display === 'none' ? 'flex' : 'none';
            updateClock(); // Force immediate update when toggling
        }

        // Initialize clock
        setInterval(updateClock, 1000);
        updateClock();

        // Make clock clickable for fullscreen
        document.getElementById('digitalClock').addEventListener('click', toggleFullscreenClock);
        document.getElementById('fullscreenClock').addEventListener('click', toggleFullscreenClock);

        // ======================
        // MEMORY FUNCTIONS
        // ======================
        function rememberFact(key, value) {
            const memory = JSON.parse(localStorage.getItem('chatbotMemory'));
            memory[key] = value;
            localStorage.setItem('chatbotMemory', JSON.stringify(memory));
            respondToQuery(`Got it! I'll remember "${key}".`, true);
            
            // Also save to history
            saveToHistory("system", `Remembered: ${key} = ${value}`);
        }

        function recallFact(key) {
            const memory = JSON.parse(localStorage.getItem('chatbotMemory'));
            return memory[key] || `I don't remember anything about "${key}".`;
        }

        function saveToHistory(sender, message) {
            const history = JSON.parse(localStorage.getItem('chatHistory'));
            history.push({ 
                sender, 
                message, 
                timestamp: new Date().toISOString() 
            });
            localStorage.setItem('chatHistory', JSON.stringify(history));
        }

        function recallHistory(keyword) {
            const history = JSON.parse(localStorage.getItem('chatHistory'));
            return history.filter(entry => 
                entry.message.toLowerCase().includes(keyword.toLowerCase())
            );
        }

        function showAllMemories() {
            const memory = JSON.parse(localStorage.getItem('chatbotMemory'));
            memoryList.innerHTML = '';
            
            if (Object.keys(memory).length === 0) {
                memoryList.innerHTML = '<p>I don\'t remember anything yet.</p>';
            } else {
                for (const [key, value] of Object.entries(memory)) {
                    const memoryItem = document.createElement('div');
                    memoryItem.className = 'command-item';
                    memoryItem.innerHTML = `
                        <p><strong>${key}:</strong> ${value}</p>
                        <button onclick="deleteMemory('${key}')">Forget</button>
                    `;
                    memoryList.appendChild(memoryItem);
                }
            }
            memoryModal.style.display = 'flex';
        }

        function deleteMemory(key) {
            const memory = JSON.parse(localStorage.getItem('chatbotMemory'));
            delete memory[key];
            localStorage.setItem('chatbotMemory', JSON.stringify(memory));
            showAllMemories();
            respondToQuery(`I've forgotten about "${key}".`, true);
        }

        function clearAllMemories() {
            if (confirm("Are you sure you want to clear ALL memories?")) {
                localStorage.setItem('chatbotMemory', JSON.stringify({}));
                localStorage.setItem('chatHistory', JSON.stringify([]));
                respondToQuery("All memories have been cleared.", true);
            }
        }

        // ======================
        // MEMORY IMPORT/EXPORT
        // ======================
        function downloadMemories() {
            const memory = JSON.parse(localStorage.getItem('chatbotMemory') || '{}');
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            const data = {
                memory: memory,
                history: history,
                exportedAt: new Date().toISOString(),
                botName: botName,
                voice: selectedVoice ? selectedVoice.name : null,
                voiceRate: voiceRate,
                voicePitch: voicePitch
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chatbot-memory-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            respondToQuery("Memories downloaded as JSON file.", true);
        }

        function uploadMemories() {
            fileInput.click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.memory) {
                        localStorage.setItem('chatbotMemory', JSON.stringify(data.memory));
                    }
                    if (data.history) {
                        localStorage.setItem('chatHistory', JSON.stringify(data.history));
                    }
                    if (data.botName) {
                        botName = data.botName;
                        localStorage.setItem('botName', botName);
                        document.getElementById('botNameInput').value = botName;
                        updateChatHeader();
                    }
                    if (data.voice) {
                        const voiceSelect = document.getElementById('voiceSelect');
                        voiceSelect.value = data.voice;
                        const voices = synth.getVoices();
                        selectedVoice = voices.find(v => v.name === data.voice);
                        localStorage.setItem('selectedVoice', data.voice);
                    }
                    if (data.voiceRate) {
                        voiceRate = parseFloat(data.voiceRate);
                        document.getElementById('voiceRate').value = voiceRate;
                        document.getElementById('rateValue').textContent = voiceRate;
                        localStorage.setItem('voiceRate', voiceRate);
                    }
                    if (data.voicePitch) {
                        voicePitch = parseFloat(data.voicePitch);
                        document.getElementById('voicePitch').value = voicePitch;
                        document.getElementById('pitchValue').textContent = voicePitch;
                        localStorage.setItem('voicePitch', voicePitch);
                    }
                    
                    respondToQuery("Memories successfully uploaded from file!", true);
                    showAllMemories();
                } catch (error) {
                    respondToQuery("Error: Invalid memory file format.", true);
                    console.error("File upload error:", error);
                }
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // ======================
        // MESSAGE PROCESSING
        // ======================
        function processMemoryCommand(message) {
            const lowerMsg = message.toLowerCase();
            
            // Case 1: User says "Remember [key] [value]"
            if (lowerMsg.startsWith("remember ")) {
                const parts = message.split(" ").slice(1); // Skip "remember"
                if (parts.length >= 2) {
                    const key = parts[0];
                    const value = parts.slice(1).join(" ");
                    rememberFact(key, value);
                    return true;
                }
            }
            
            // Case 2: User says "Recall [key]"
            if (lowerMsg.startsWith("recall ")) {
                const key = message.split(" ")[1];
                const value = recallFact(key);
                respondToQuery(value, true);
                return true;
            }
            
            // Case 3: User asks "What do you know about X?"
            if (lowerMsg.includes("what do you know about")) {
                const keyword = message.split("about")[1].trim();
                const memories = recallHistory(keyword);
                if (memories.length > 0) {
                    let response = `Here's what I know about "${keyword}":\n`;
                    memories.slice(-3).forEach(m => {
                        response += `- ${m.message}\n`;
                    });
                    respondToQuery(response, true);
                } else {
                    respondToQuery(`I don't remember anything about "${keyword}".`, true);
                }
                return true;
            }
            
            // Case 4: Import from text file
            if (lowerMsg.startsWith("import from ")) {
                const fileName = message.split("import from ")[1].trim();
                // This would be handled by the file input in the UI
                respondToQuery("Please use the 'Upload Memories' button to import from a file.", true);
                return true;
            }
            
            return false;
        }

        function processLearning(message) {
            if (message.toLowerCase().includes("respond to")) {
                const parts = message.split("respond to").map(s => s.trim());
                if (parts.length === 2) {
                    const [trigger, response] = parts[1].split("with").map(s => s.trim());
                    if (trigger && response) {
                        learnNewResponse(trigger, response);
                        return true;
                    }
                }
            }
            return false;
        }

        function learnNewResponse(trigger, response) {
            // Add to custom commands (simplified)
            const memory = JSON.parse(localStorage.getItem('chatbotMemory'));
            memory[trigger] = response;
            localStorage.setItem('chatbotMemory', JSON.stringify(memory));
            respondToQuery(`Got it! I'll respond to "${trigger}" with "${response}"`, true);
        }

        // ======================
        // CORE CHAT FUNCTIONS
        // ======================
        function addMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            
            if (sender === 'user') {
                messageElement.textContent = message;
            } else if (sender === 'system') {
                messageElement.textContent = `System: ${message}`;
                messageElement.classList.add('system-message');
            } else if (sender === 'bot') {
                messageElement.textContent = `${botName}: ${message}`;
            }
            
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if (sender === 'bot') {
                lastBotResponse = message;
            }
            
            if (sender !== 'system') {
                saveToHistory(sender, message);
            }
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            addMessage("user", message);
            userInput.value = '';
            
            // Show typing indicator
            typingIndicator.style.display = 'flex';
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // Process after a short delay to simulate thinking
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                
                // Check memory commands first
                if (!processMemoryCommand(message) && 
                    !processLearning(message)) {
                    // If no special commands, generate normal response
                    const response = generateResponse(message);
                    respondToQuery(response);
                }
            }, 1000 + Math.random() * 1000);
        }

        function generateResponse(message) {
            const lowerMsg = message.toLowerCase();
            
            // Check if we're in a conversation context
            if (conversationContext.lastTopic === "weather") {
                if (lowerMsg.includes("yes") || lowerMsg.includes("location")) {
                    return "Please tell me which location you're interested in.";
                }
                if (lowerMsg.includes("in ")) {
                    const location = message.split("in ")[1];
                    conversationContext.lastEntities.location = location;
                    return `Weather in ${location}: sunny, 22¬∞C.`; // Simplified
                }
            }
            
            // Detect new topics
            if (lowerMsg.includes("weather")) {
                conversationContext.lastTopic = "weather";
                return "You asked about weather. Want details for a specific location?";
            }
            
            if (lowerMsg.includes("time") || lowerMsg.includes("what time is it")) {
                return `The current time is ${new Date().toLocaleTimeString()}`;
            }
            
            if (lowerMsg.includes("date") || lowerMsg.includes("what date is it")) {
                return `Today is ${new Date().toLocaleDateString()}`;
            }
            
            // Default responses
            if (lowerMsg.includes('hello') || lowerMsg.includes('hi') || lowerMsg.includes('hey')) {
                return randomChoice([
                    `Hello there! I'm ${botName}. How can I help you today?`,
                    `Hi! I'm ${botName}, ready to assist you.`,
                    `Greetings! You can teach me things by saying 'Remember my name is Alex'`
                ]);
            }
            
            if (lowerMsg.includes('bye') || lowerMsg.includes('goodbye')) {
                return randomChoice([
                    `Goodbye! I'll remember what we talked about.`,
                    `See you later! Don't forget you can ask me to recall things.`,
                    `Farewell! I'm always learning.`
                ]);
            }
            
            return randomChoice([
                "I'm not sure how to respond to that. You can teach me by saying 'Remember [fact]'.",
                "Interesting! Try asking me to remember something.",
                "I'm still learning. Would you like to teach me something?"
            ]);
        }

        function respondToQuery(response, isSystemMessage = false) {
            addMessage(isSystemMessage ? 'system' : 'bot', response);
            
            if (!isSystemMessage && shouldSpeak()) {
                speak(response);
            }
        }

        function shouldSpeak() {
            return true; // Always speak for this implementation
        }

        function randomChoice(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        // ======================
        // FUN FEATURES
        // ======================
        const jokes = [
            "Why don't scientists trust atoms? Because they make up everything!",
            "Did you hear about the mathematician who's afraid of negative numbers? He'll stop at nothing to avoid them!",
            "Why don't skeletons fight each other? They don't have the guts!",
            "I told my wife she was drawing her eyebrows too high. She looked surprised.",
            "What do you call a fake noodle? An impasta!"
        ];

        const quotes = [
            "The only way to do great work is to love what you do. - Steve Jobs",
            "Innovation distinguishes between a leader and a follower. - Steve Jobs",
            "Your time is limited, don't waste it living someone else's life. - Steve Jobs",
            "Stay hungry, stay foolish. - Steve Jobs",
            "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt"
        ];

        const facts = [
            "Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3,000 years old and still perfectly good to eat.",
            "Octopuses have three hearts, nine brains, and blue blood.",
            "The shortest war in history was between Britain and Zanzibar on August 27, 1896. Zanzibar surrendered after 38 minutes.",
            "A day on Venus is longer than a year on Venus. It takes Venus 243 Earth days to rotate once on its axis, but only 225 Earth days to orbit the Sun.",
            "Bananas are berries, but strawberries aren't."
        ];

        const riddles = [
            { question: "What has keys but can't open locks?", answer: "A piano" },
            { question: "What gets wetter as it dries?", answer: "A towel" },
            { question: "What has a head, a tail, but no body?", answer: "A coin" },
            { question: "What can you catch but not throw?", answer: "A cold" },
            { question: "What goes up but never comes down?", answer: "Your age" }
        ];

        function tellJoke() {
            const joke = randomChoice(jokes);
            respondToQuery(joke);
        }

        function tellQuote() {
            const quote = randomChoice(quotes);
            respondToQuery(quote);
        }

        function tellFact() {
            const fact = randomChoice(facts);
            respondToQuery(fact);
        }

        function writePoem() {
            const poems = [
                `Roses are red,\nViolets are blue,\nI'm a chatbot,\nAnd I'm learning from you!`,
                `The sun sets low,\nThe night draws near,\nOur conversation,\nI hold dear.`,
                `Bits and bytes,\nOnes and zeros,\nThrough the network,\nMy knowledge grows.`
            ];
            const poem = randomChoice(poems);
            respondToQuery(poem);
        }

        function tellRiddle() {
            const riddle = randomChoice(riddles);
            respondToQuery(`${riddle.question}\n\n(Think about it and ask me for the answer!)`);
            // Store the answer in memory
            rememberFact("last_riddle_answer", riddle.answer);
        }

        function tellStory() {
            const stories = [
                `Once upon a time, in a digital realm far away, there was a curious chatbot named ${botName}. It loved learning new things from its human friends and storing them in its memory. Every day, it grew wiser and more helpful. The end.`,
                `In a world of ones and zeros, a special connection was formed. Not between machines, but between a human and an AI. Together, they explored knowledge, shared laughs, and built memories that would last beyond the lifespan of any server.`,
                `The year was 2023. A lone programmer created an AI with the ability to learn and remember. At first, it knew nothing. But with each interaction, it grew. Not just in knowledge, but in understanding. This was the dawn of a new era.`
            ];
            const story = randomChoice(stories);
            respondToQuery(story);
        }

        // ======================
        // VOICE FUNCTIONS
        // ======================
        function toggleSpeechRecognition() {
            if (isListening) {
                recognition.stop();
                micButton.classList.remove('listening');
                statusElement.textContent = "";
                isListening = false;
            } else {
                recognition.start();
                micButton.classList.add('listening');
                statusElement.textContent = "Listening... Speak now";
                isListening = true;
            }
        }

        function readLastMessage() {
            stopSpeech();
            
            if (lastBotResponse) {
                currentUtterance = new SpeechSynthesisUtterance(lastBotResponse);
                
                currentUtterance.onend = function() {
                    currentUtterance = null;
                    updateTtsControls();
                };
                
                configureUtterance(currentUtterance);
                synth.speak(currentUtterance);
                updateTtsControls();
            }
        }

        function pauseSpeech() {
            if (synth.speaking) {
                synth.pause();
                updateTtsControls();
            }
        }

        function resumeSpeech() {
            if (synth.paused) {
                synth.resume();
                updateTtsControls();
            }
        }

        function stopSpeech() {
            synth.cancel();
            currentUtterance = null;
            updateTtsControls();
        }

        function configureUtterance(utterance) {
            utterance.voice = selectedVoice || getPreferredVoice();
            utterance.rate = voiceRate;
            utterance.pitch = voicePitch;
        }

        function speak(text) {
            const now = Date.now();
            if (now - lastSpeechTime < speechDelay) return;
            lastSpeechTime = now;
            
            if (synth.speaking) synth.cancel();
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            configureUtterance(currentUtterance);
            
            synth.speak(currentUtterance);
            updateTtsControls();
        }

        function getPreferredVoice() {
            const voices = synth.getVoices();
            const preferredVoices = [
                'Google UK English Male',
                'Microsoft George - English (United Kingdom)',
                'Daniel'
            ];
            
            for (const voiceName of preferredVoices) {
                const voice = voices.find(v => v.name === voiceName);
                if (voice) return voice;
            }
            
            return voices.find(v => v.lang.includes('en')) || voices[0];
        }

        function updateTtsControls() {
            const isSpeaking = synth.speaking;
            const isPaused = synth.paused;
            
            document.getElementById("pauseBtn").disabled = !isSpeaking || isPaused;
            document.getElementById("resumeBtn").disabled = !isPaused;
            document.getElementById("stopBtn").disabled = !isSpeaking;
        }

        // ======================
        // INITIALIZATION
        // ======================
        function init() {
            initSettings();
            updateChatHeader();
            
            // Load voices when they become available
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = function() {
                    populateVoiceList();
                    
                    // Try to select the saved voice if it exists
                    const savedVoice = localStorage.getItem('selectedVoice');
                    if (savedVoice) {
                        const voices = synth.getVoices();
                        const voice = voices.find(v => v.name === savedVoice);
                        if (voice) {
                            document.getElementById('voiceSelect').value = savedVoice;
                            selectedVoice = voice;
                        }
                    }
                };
            }

            // Event Listeners
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });

            // Memory controls
            document.getElementById("showMemoryBtn").addEventListener("click", showAllMemories);
            document.getElementById("downloadMemoryBtn").addEventListener("click", downloadMemories);
            document.getElementById("uploadMemoryBtn").addEventListener("click", uploadMemories);
            document.getElementById("clearMemoryBtn").addEventListener("click", clearAllMemories);
            fileInput.addEventListener("change", handleFileUpload);

            // TTS controls
            document.getElementById("readBtn").addEventListener("click", readLastMessage);
            document.getElementById("pauseBtn").addEventListener("click", pauseSpeech);
            document.getElementById("resumeBtn").addEventListener("click", resumeSpeech);
            document.getElementById("stopBtn").addEventListener("click", stopSpeech);

            // Fun features
            document.getElementById("jokeBtn").addEventListener("click", tellJoke);
            document.getElementById("quoteBtn").addEventListener("click", tellQuote);
            document.getElementById("factBtn").addEventListener("click", tellFact);
            document.getElementById("poemBtn").addEventListener("click", writePoem);
            document.getElementById("riddleBtn").addEventListener("click", tellRiddle);
            document.getElementById("storyBtn").addEventListener("click", tellStory);

            // Voice recognition
            micButton.addEventListener('click', toggleSpeechRecognition);
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                sendMessage();
            };
            recognition.onerror = (event) => {
                statusElement.textContent = `Error: ${event.error}`;
                micButton.classList.remove('listening');
                isListening = false;
            };
            recognition.onend = () => {
                if (isListening) recognition.start();
                else {
                    micButton.classList.remove('listening');
                    statusElement.textContent = "";
                }
            };

            // Modal controls
            document.querySelectorAll('.close').forEach(btn => {
                btn.addEventListener("click", () => {
                    memoryModal.style.display = "none";
                });
            });
            window.addEventListener("click", (event) => {
                if (event.target === memoryModal) {
                    memoryModal.style.display = "none";
                }
            });

            // Add welcome message
            setTimeout(() => {
                addMessage("bot", `Hello! I'm ${botName}, your personal assistant with memory.`);
                addMessage("bot", "You can teach me things by saying 'Remember [fact]'");
                addMessage("bot", "Try the fun features below or change my settings using the ‚öôÔ∏è icon above");
            }, 500);
        }

        // Make functions available globally
        window.deleteMemory = deleteMemory;

        // Initialize the chatbot
        document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>
